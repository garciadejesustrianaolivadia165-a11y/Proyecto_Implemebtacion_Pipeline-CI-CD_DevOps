# 🛠️ COMANDOS ÚTILES - CHEAT SHEET

## 📦 NPM / Node.js

### Instalación
```bash
cd Proyecto_Final_DevOps/backend
npm install                    # Instalar todas las dependencias
npm install --save <paquete>   # Agregar nueva dependencia
npm install --save-dev <pkg>   # Agregar dev dependency
npm ci                         # Instalación limpia (para CI/CD)
```

### Ejecución
```bash
npm start                      # Modo producción
npm run dev                    # Modo desarrollo (con nodemon)
node src/app.js               # Ejecutar directamente
```

### Testing
```bash
npm test                       # Ejecutar todas las pruebas
npm test -- --coverage         # Con reporte de cobertura
npm test -- --watch           # Modo watch
npm test -- --verbose         # Con detalles
npm test -- math.test.js      # Solo un archivo
npm run lint                   # Ejecutar ESLint
npm run lint -- --fix         # Auto-corregir problemas
```

### Limpieza
```bash
rm -rf node_modules           # Eliminar node_modules
rm package-lock.json          # Eliminar lock file
npm cache clean --force       # Limpiar caché de npm
npm install                    # Reinstalar
```

---

## 🐳 Docker

### Comandos Básicos
```bash
docker --version              # Verificar instalación
docker ps                     # Contenedores activos
docker ps -a                  # Todos los contenedores
docker images                 # Ver imágenes
docker system df              # Uso de espacio
```

### Build & Run
```bash
# Build imagen
docker build -t adonismburet/devops-app:latest -f backend/Dockerfile .
docker build -t devops-app:v1.0.0 ./backend

# Ejecutar contenedor
docker run -p 3000:3000 adonismburet/devops-app
docker run -d -p 3000:3000 adonismburet/devops-app  # En background
docker run -it adonismburet/devops-app /bin/bash    # Modo interactivo
```

### Gestión de Contenedores
```bash
docker start <container-id>    # Iniciar
docker stop <container-id>     # Detener
docker restart <container-id>  # Reiniciar
docker rm <container-id>       # Eliminar
docker rm -f <container-id>    # Forzar eliminación
docker logs <container-id>     # Ver logs
docker logs -f <container-id>  # Seguir logs
docker exec -it <id> /bin/bash # Acceder al contenedor
```

### Limpieza Docker
```bash
docker container prune        # Eliminar contenedores detenidos
docker image prune            # Eliminar imágenes sin usar
docker volume prune           # Eliminar volúmenes sin usar
docker system prune           # Limpieza general
docker system prune -a        # Limpieza completa
```

---

## 🐳 Docker Compose

### Comandos Principales
```bash
cd Proyecto_Final_DevOps/infra

# Iniciar servicios
docker-compose up              # En foreground
docker-compose up -d           # En background
docker-compose up --build      # Rebuilding imágenes

# Detener servicios
docker-compose stop            # Detener sin eliminar
docker-compose down            # Detener y eliminar
docker-compose down -v         # Eliminar también volúmenes
```

### Gestión de Servicios
```bash
docker-compose ps              # Estado de servicios
docker-compose logs            # Logs de todos
docker-compose logs -f         # Seguir logs
docker-compose logs -f app     # Logs de un servicio
docker-compose restart         # Reiniciar todos
docker-compose restart app     # Reiniciar uno
docker-compose exec app bash   # Acceder al contenedor
```

### Build y Scale
```bash
docker-compose build           # Build todas las imágenes
docker-compose build app       # Build un servicio
docker-compose pull            # Actualizar imágenes
docker-compose scale app=3     # Escalar servicio
```

---

## 🔧 Git

### Configuración Inicial
```bash
git config --global user.name "Tu Nombre"
git config --global user.email "tu@email.com"
git config --list              # Ver configuración
```

### Comandos Básicos
```bash
git status                     # Ver cambios
git add .                      # Agregar todos los cambios
git add archivo.js             # Agregar archivo específico
git commit -m "mensaje"        # Commit con mensaje
git commit -am "mensaje"       # Add + commit
git push                       # Push al remoto
git push origin main           # Push a branch específico
git pull                       # Pull del remoto
git pull origin main           # Pull de branch específico
```

### Branches
```bash
git branch                     # Listar branches
git branch nombre              # Crear branch
git checkout nombre            # Cambiar de branch
git checkout -b nombre         # Crear y cambiar
git merge nombre               # Mergear branch
git branch -d nombre           # Eliminar branch
git push origin --delete rama  # Eliminar branch remoto
```

### Historial y Logs
```bash
git log                        # Ver historial
git log --oneline              # Historial compacto
git log --graph               # Historial gráfico
git show                       # Ver último commit
git diff                       # Ver cambios no staged
git diff --staged             # Ver cambios staged
```

### Deshacer Cambios
```bash
git checkout -- archivo        # Descartar cambios
git reset HEAD archivo         # Unstage archivo
git reset --soft HEAD~1        # Deshacer último commit (mantener cambios)
git reset --hard HEAD~1        # Deshacer último commit (eliminar cambios)
git revert <commit-id>         # Revertir commit
```

### Stash (Guardar temporalmente)
```bash
git stash                      # Guardar cambios
git stash list                 # Ver stashes
git stash pop                  # Aplicar último stash
git stash apply                # Aplicar sin eliminar
git stash drop                 # Eliminar stash
```

---

## 🐙 GitHub

### Clonar y Remote
```bash
git clone <url>                # Clonar repositorio
git remote -v                  # Ver remotos
git remote add origin <url>    # Agregar remoto
git remote set-url origin <url> # Cambiar URL
```

### Pull Requests
```bash
# Workflow típico
git checkout -b feature/nueva-funcionalidad
# ... hacer cambios ...
git add .
git commit -m "feat: nueva funcionalidad"
git push origin feature/nueva-funcionalidad
# Crear PR en GitHub web
```

### Tags (Versiones)
```bash
git tag                        # Listar tags
git tag v1.0.0                 # Crear tag
git tag -a v1.0.0 -m "msg"    # Tag con mensaje
git push origin v1.0.0         # Push tag específico
git push origin --tags         # Push todos los tags
```

---

## 🧪 Testing / Jest

### Ejecutar Tests
```bash
npm test                       # Todas las pruebas
npm test -- --coverage         # Con cobertura
npm test -- --watch           # Modo watch
npm test -- --verbose         # Modo verbose
npm test -- --detectOpenHandles # Debug de timeouts
npm test -- archivo.test.js   # Test específico
npm test -- --testNamePattern="nombre" # Test por nombre
```

### Ver Cobertura
```bash
npm test -- --coverage        # Generar reporte
# Abrir coverage/lcov-report/index.html en navegador
```

---

## 🔍 ESLint

### Comandos
```bash
npm run lint                   # Analizar código
npm run lint -- --fix         # Auto-corregir
npx eslint archivo.js         # Lint archivo específico
npx eslint . --ext .js        # Lint todos los JS
```

---

## 🔄 CI/CD / GitHub Actions

### Ver Workflows
```bash
# Desde GitHub web:
# Repo → Actions → Ver workflows
```

### Reejecutar Pipeline
```bash
# Desde GitHub Actions web:
# Click en workflow → Re-run jobs
```

### Ver Logs
```bash
# GitHub web → Actions → Click en workflow → Ver logs
```

---

## 🗄️ MongoDB

### Conectar a MongoDB
```bash
# Desde host
mongo mongodb://localhost:27017/devops_demo
mongosh mongodb://localhost:27017/devops_demo

# Desde contenedor
docker exec -it mongodb mongosh
docker-compose exec db mongosh
```

### Comandos MongoDB
```javascript
// Listar bases de datos
show dbs

// Usar base de datos
use devops_demo

// Listar colecciones
show collections

// Insertar documento
db.users.insertOne({name: "Test", email: "test@test.com"})

// Buscar documentos
db.users.find()
db.users.find({name: "Test"})
db.users.find().pretty()

// Actualizar documento
db.users.updateOne({name: "Test"}, {$set: {email: "new@test.com"}})

// Eliminar documento
db.users.deleteOne({name: "Test"})
db.users.deleteMany({})

// Contar documentos
db.users.countDocuments()

// Crear índice
db.users.createIndex({email: 1})
```

### Backup y Restore
```bash
# Backup
docker exec mongodb mongodump --out /data/backup
docker cp mongodb:/data/backup ./backup-$(date +%Y%m%d)

# Restore
docker cp ./backup mongodb:/data/restore
docker exec mongodb mongorestore /data/restore
```

---

## 📊 Prometheus

### Acceder
```bash
# Abrir en navegador
http://localhost:9090
```

### Queries Útiles
```promql
# Peticiones por segundo
rate(http_requests_total[5m])

# Uso de memoria
nodejs_heap_size_used_bytes / 1024 / 1024

# Uptime
time() - nodejs_process_start_time_seconds

# Peticiones activas
nodejs_active_requests

# CPU usage
rate(process_cpu_seconds_total[5m])
```

---

## 🐧 Sistema (Linux/Mac)

### Procesos y Puertos
```bash
# Ver procesos usando un puerto
lsof -i :3000
lsof -ti:3000                 # Solo PID

# Matar proceso
kill <PID>
kill -9 <PID>                 # Forzar
lsof -ti:3000 | xargs kill -9 # Matar puerto 3000

# Ver procesos de node
ps aux | grep node
```

### Espacio en Disco
```bash
df -h                          # Espacio en disco
du -sh *                       # Tamaño de carpetas
du -sh node_modules            # Tamaño de node_modules
```

---

## 🪟 Sistema (Windows)

### Procesos y Puertos
```cmd
# Ver procesos usando un puerto
netstat -ano | findstr :3000

# Matar proceso
taskkill /PID <PID> /F

# Ver procesos de node
tasklist | findstr node
```

---

## 🔧 Troubleshooting Rápido

### Puerto Ocupado
```bash
# Linux/Mac
lsof -ti:3000 | xargs kill -9

# Windows
netstat -ano | findstr :3000
taskkill /PID <PID> /F
```

### Tests Fallan
```bash
npm test -- --verbose
npm test -- --detectOpenHandles
npm run lint
```

### Docker No Funciona
```bash
docker-compose down
docker-compose up --build --force-recreate
docker-compose logs -f
```

### MongoDB No Conecta
```bash
docker-compose restart db
docker-compose logs db
docker exec -it mongodb mongosh
```

### Caché Problemas
```bash
npm cache clean --force
rm -rf node_modules package-lock.json
npm install
```

---

## 🌐 URLs Útiles

```bash
# Aplicación
http://localhost:3000

# API Health Check
http://localhost:3000/api/health

# API Hello
http://localhost:3000/api/hello?name=DevOps

# Prometheus
http://localhost:9090

# MongoDB (cliente GUI)
mongodb://localhost:27017
```

---

## 🔄 Workflow Completo

### Desarrollo Normal
```bash
# 1. Actualizar repositorio
git pull origin main

# 2. Crear branch
git checkout -b feature/nueva-funcionalidad

# 3. Hacer cambios
# ... editar código ...

# 4. Probar localmente
npm test
npm run lint
npm run dev

# 5. Commit y push
git add .
git commit -m "feat: nueva funcionalidad"
git push origin feature/nueva-funcionalidad

# 6. Crear PR en GitHub
# 7. Esperar aprobación
# 8. Merge a main
```

### Despliegue
```bash
# 1. Build y test
npm test -- --coverage
npm run lint

# 2. Build Docker
cd Proyecto_Final_DevOps
docker build -t adonismburet/devops-app:latest -f backend/Dockerfile .

# 3. Test con Docker
docker run -p 3000:3000 adonismburet/devops-app

# 4. Tag y push
docker push adonismburet/devops-app:latest

# 5. Deploy con compose
cd infra
docker-compose pull
docker-compose up -d --force-recreate
```

---

## 💡 Tips Finales

1. **Siempre ejecuta tests antes de push**: `npm test`
2. **Usa lint para código limpio**: `npm run lint -- --fix`
3. **Commitea frecuentemente con mensajes claros**
4. **Prueba con Docker antes de deploy**
5. **Lee los logs cuando algo falla**: `docker-compose logs -f`
6. **Mantén node_modules en .gitignore**
7. **Usa .dockerignore para imágenes más pequeñas**

---

**📚 Para más información, consulta la documentación completa en `/docs`**
