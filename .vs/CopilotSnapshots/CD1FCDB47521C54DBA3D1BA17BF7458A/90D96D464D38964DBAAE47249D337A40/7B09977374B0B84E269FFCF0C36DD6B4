# Documentación del Pipeline CI/CD

## Arquitectura del Pipeline

```
┌─────────────┐
│   GitHub    │
│  (Push/PR)  │
└─────────────┘
       │
       ▼
┌───────────────────────────────┐
│     GitHub Actions Workflow   │
└───────────────────────────────┘
       │
       ├──► Test Stage
       │    ├─ Install Dependencies
       │    ├─ ESLint
       │    ├─ Jest Tests
       │    └─ Coverage Report
       │
       ├──► Build Stage
       │    ├─ Docker Build
       │    └─ Push to Docker Hub
       │
       └──► Deploy Stage
            └─ Deployment Notification
```

## Stages del Pipeline

### 1. Test Stage
**Propósito**: Validar la calidad y funcionalidad del código

#### Pasos:
1. **Checkout código**: Descarga el código del repositorio
2. **Setup Node.js**: Configura Node.js v18
3. **Instalar dependencias**: `npm ci` (instalación limpia)
4. **ESLint**: Análisis estático de código
5. **Jest Tests**: Pruebas unitarias e integración
6. **Coverage Report**: Genera reporte de cobertura

#### Triggers:
- Push a `main` o `develop`
- Pull Request a `main`

#### Comandos:
```bash
npm ci
npm run lint
npm test -- --coverage
```

### 2. Build Stage
**Propósito**: Crear y publicar imagen Docker

#### Pasos:
1. **Login Docker Hub**: Autenticación con secrets
2. **Build imagen**: Construye desde Dockerfile
3. **Push imagen**: Publica con tags `latest` y SHA

#### Requisitos:
- Test stage exitoso
- Push a branch `main`

#### Tags Generados:
- `usuario/devops-app:latest`
- `usuario/devops-app:<commit-sha>`

### 3. Deploy Stage
**Propósito**: Notificar disponibilidad para despliegue

#### Acciones:
- Muestra mensaje de éxito
- Indica imagen disponible
- Lista para despliegue manual/automático

## Archivos de Configuración

### `.github/workflows/ci-cd.yml`
Workflow principal que orquesta todo el pipeline.

**Características**:
- 3 jobs: test, build, deploy
- Dependencias entre jobs
- Caché de dependencias
- Secrets management
- Artifacts de cobertura

### Variables de Entorno
```yaml
NODE_ENV: test
PORT: 3000
```

### Secrets Requeridos
| Secret | Descripción | Dónde obtenerlo |
|--------|-------------|-----------------|
| `DOCKER_USERNAME` | Usuario Docker Hub | hub.docker.com |
| `DOCKER_PASSWORD` | Token de acceso | hub.docker.com/settings/security |

## Métricas del Pipeline

### Tiempos Estimados
- **Test Stage**: 2-3 minutos
- **Build Stage**: 3-5 minutos
- **Deploy Stage**: < 1 minuto
- **Total**: ~6-9 minutos

### Criterios de Éxito
- ✅ ESLint sin errores
- ✅ Todas las pruebas pasan
- ✅ Cobertura > 50%
- ✅ Imagen Docker construida
- ✅ Imagen publicada en Docker Hub

## Manejo de Errores

### Error en Tests
**Causa**: Prueba falla o timeout

**Solución**:
```bash
# Ejecutar localmente
npm test -- --verbose

# Ver logs detallados
npm test -- --detectOpenHandles
```

### Error en Build Docker
**Causa**: Dockerfile mal configurado

**Solución**:
```bash
# Build local
docker build -t test-image ./backend

# Ver logs
docker build --progress=plain -t test-image ./backend
```

### Error en Push Docker Hub
**Causa**: Credenciales incorrectas

**Solución**:
1. Verificar secrets en GitHub
2. Regenerar token en Docker Hub
3. Actualizar secret `DOCKER_PASSWORD`

## Monitoreo del Pipeline

### Ver Ejecución
1. Ve a tu repositorio en GitHub
2. Click en tab **Actions**
3. Selecciona workflow run
4. Inspecciona logs de cada job

### Badges de Estado
Agrega a tu README.md:
```markdown
![CI/CD Pipeline](https://github.com/usuario/repo/workflows/CI/CD%20Pipeline/badge.svg)
```

## Optimizaciones

### Caché de Dependencias
```yaml
- uses: actions/setup-node@v3
  with:
    cache: 'npm'
    cache-dependency-path: backend/package-lock.json
```

### Build Paralelo
Los jobs `test` y `build` pueden correr en paralelo si no hay dependencia.

### Reducir Tamaño de Imagen
- Usar `.dockerignore`
- Multi-stage builds
- Imagen base Alpine

## Extensiones Futuras

### Posibles Mejoras
- [ ] Notificaciones a Slack/Discord
- [ ] Deploy automático a cloud
- [ ] Escaneo de seguridad (Snyk)
- [ ] Performance testing
- [ ] Rollback automático

### Integraciones Adicionales
- **SonarQube**: Análisis de código avanzado
- **Trivy**: Escaneo de vulnerabilidades
- **Terraform**: Infraestructura como código
- **Kubernetes**: Orquestación de contenedores

## Troubleshooting

### Pipeline no se ejecuta
- Verifica que `.github/workflows/` esté en la raíz
- Revisa sintaxis YAML en https://yamllint.com
- Confirma que el workflow esté habilitado

### Tests pasan localmente pero fallan en CI
- Diferencias de sistema operativo
- Variables de entorno faltantes
- Timeouts en GitHub Actions

### Imagen Docker no se publica
- Verifica permisos del token
- Confirma nombre de usuario correcto
- Revisa límites de Docker Hub (free tier)

## Referencias
- [GitHub Actions Docs](https://docs.github.com/en/actions)
- [Docker Hub](https://hub.docker.com/)
- [Jest Documentation](https://jestjs.io/)
- [ESLint Rules](https://eslint.org/docs/rules/)
